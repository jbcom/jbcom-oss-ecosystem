# Tox configuration for jbcom control center
# Runs tests across all packages in packages/
# Uses tox-uv for uv workspace integration and tox-gh for GitHub Actions

[tox]
requires =
    tox>=4.11
    tox-uv>=1.11
    tox-gh>=1.3
env_list =
    py39,py310,py311,py312,py313
    lint
    typecheck
min_version = 4.11
skip_missing_interpreters = true

[gh]
python =
    3.9 = py39
    3.10 = py310
    3.11 = py311
    3.12 = py312
    3.13 = py313

# Base test environment - installs all workspace packages
[testenv]
package = skip
deps =
    pytest>=8.0.0
    pytest-cov>=5.0.0
    pytest-xdist>=3.5.0
    pytest-asyncio>=0.23.0
    pytest-mock>=3.14.0
    # Install workspace packages with test dependencies
    {toxinidir}/packages/extended-data-types[tests]
    {toxinidir}/packages/lifecyclelogging[tests]
    {toxinidir}/packages/directed-inputs-class[tests]
    {toxinidir}/packages/python-terraform-bridge[test]
    {toxinidir}/packages/vendor-connectors[tests]
    {toxinidir}/packages/mesh-toolkit[tests]
    {toxinidir}/internal/crewai[tests]
changedir = {toxinidir}
commands =
    # Test all packages
    pytest packages/extended-data-types/tests {posargs}
    pytest packages/lifecyclelogging/tests {posargs}
    pytest packages/directed-inputs-class/tests {posargs}
    pytest packages/python-terraform-bridge/tests {posargs}
    pytest packages/vendor-connectors/tests {posargs}
    pytest packages/mesh-toolkit/tests {posargs}
    pytest internal/crewai/tests {posargs}

# Individual package environments using workspace dependencies
[testenv:extended-data-types]
changedir = {toxinidir}/packages/extended-data-types
deps = {toxinidir}/packages/extended-data-types[tests]
commands = pytest tests {posargs}

[testenv:lifecyclelogging]
changedir = {toxinidir}/packages/lifecyclelogging
deps = {toxinidir}/packages/lifecyclelogging[tests]
commands = pytest tests {posargs}

[testenv:directed-inputs-class]
changedir = {toxinidir}/packages/directed-inputs-class
deps = {toxinidir}/packages/directed-inputs-class[tests]
commands = pytest tests {posargs}

[testenv:vendor-connectors]
changedir = {toxinidir}/packages/vendor-connectors
deps = {toxinidir}/packages/vendor-connectors[tests]
commands = pytest tests {posargs}

[testenv:python-terraform-bridge]
changedir = {toxinidir}/packages/python-terraform-bridge
deps = {toxinidir}/packages/python-terraform-bridge[test]
commands = pytest tests {posargs}

[testenv:mesh-toolkit]
changedir = {toxinidir}/packages/mesh-toolkit
deps = {toxinidir}/packages/mesh-toolkit[tests]
commands = pytest tests {posargs}

[testenv:crew-agents]
changedir = {toxinidir}/internal/crewai
deps =
    {toxinidir}/internal/crewai[tests]
    {toxinidir}/packages/mesh-toolkit
commands = pytest tests {posargs}

# Lint all packages
[testenv:lint]
skip_install = true
deps = ruff>=0.2.0
commands =
    ruff check packages/
    ruff check internal/crewai/
    ruff format --check packages/
    ruff format --check internal/crewai/

# Type check all packages
[testenv:typecheck]
skip_install = true
deps =
    mypy>=1.8.0
    {toxinidir}/packages/extended-data-types[typing]
    {toxinidir}/packages/lifecyclelogging[typing]
commands =
    mypy packages/extended-data-types/src
    mypy packages/lifecyclelogging/src
